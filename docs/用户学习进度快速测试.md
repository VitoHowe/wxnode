# 用户学习进度 - 快速测试指南

## ✅ 功能已完成

用户学习进度系统已创建完成，包括：
- ✅ 数据表: `user_study_progress`
- ✅ Service层: `userProgressService.ts`
- ✅ Controller层: `userProgressController.ts`
- ✅ Routes层: `userProgress.ts`
- ✅ 已注册到 `app.ts`

---

## 🚀 快速测试

### 前提条件
- 服务器已启动
- 已登录获取Token
- 数据库中有题库数据

### 测试环境变量
```json
{
  "base_url": "http://localhost:3001",
  "token": "your_jwt_token",
  "bank_id": 2,
  "user_id": 1
}
```

---

## 📋 测试用例

### 1. 首次进入题库（获取进度）

**请求**:
```bash
GET http://localhost:3001/api/user-progress/2
Authorization: Bearer YOUR_TOKEN
```

**预期结果**: 
```json
{
  "code": 200,
  "message": "暂无学习进度",
  "data": null
}
```

---

### 2. 开始学习（保存进度）

**请求**:
```bash
POST http://localhost:3001/api/user-progress/2
Authorization: Bearer YOUR_TOKEN
Content-Type: application/json

{
  "parse_result_id": 5,
  "current_question_index": 1,
  "completed_count": 1,
  "total_questions": 50
}
```

**预期结果**:
```json
{
  "code": 200,
  "message": "保存学习进度成功",
  "data": {
    "id": 1,
    "user_id": 10,
    "bank_id": 2,
    "current_question_index": 1,
    "completed_count": 1,
    "total_questions": 50,
    "progress_percentage": 2
  }
}
```

---

### 3. 继续学习（更新进度）

**请求**:
```bash
POST http://localhost:3001/api/user-progress/2
Authorization: Bearer YOUR_TOKEN
Content-Type: application/json

{
  "current_question_index": 10,
  "completed_count": 10,
  "total_questions": 50
}
```

**预期结果**:
```json
{
  "code": 200,
  "message": "保存学习进度成功",
  "data": {
    "current_question_index": 10,
    "completed_count": 10,
    "total_questions": 50,
    "progress_percentage": 20
  }
}
```

---

### 4. 再次进入题库（断点续学）

**请求**:
```bash
GET http://localhost:3001/api/user-progress/2
Authorization: Bearer YOUR_TOKEN
```

**预期结果**:
```json
{
  "code": 200,
  "message": "获取学习进度成功",
  "data": {
    "current_question_index": 10,
    "completed_count": 10,
    "total_questions": 50,
    "progress_percentage": 20
  }
}
```

---

### 5. 查看所有学习进度

**请求**:
```bash
GET http://localhost:3001/api/user-progress
Authorization: Bearer YOUR_TOKEN
```

**预期结果**:
```json
{
  "code": 200,
  "message": "获取所有学习进度成功",
  "data": [
    {
      "bank_id": 2,
      "current_question_index": 10,
      "progress_percentage": 20
    }
  ]
}
```

---

### 6. 查看最近学习的题库

**请求**:
```bash
GET http://localhost:3001/api/user-progress/recent?limit=3
Authorization: Bearer YOUR_TOKEN
```

**预期结果**:
```json
{
  "code": 200,
  "message": "获取最近学习题库成功",
  "data": [...]
}
```

---

### 7. 重置进度

**请求**:
```bash
DELETE http://localhost:3001/api/user-progress/2
Authorization: Bearer YOUR_TOKEN
```

**预期结果**:
```json
{
  "code": 200,
  "message": "重置学习进度成功",
  "data": null
}
```

---

## 🧪 完整测试流程

### Postman/Apifox 测试步骤

1. **设置环境变量**
   - base_url: `http://localhost:3001`
   - token: 从登录接口获取
   - bank_id: 现有题库ID

2. **测试顺序**
   ```
   ① 获取进度（应该为空）
   ② 保存进度（index=1）
   ③ 获取进度（应该显示index=1）
   ④ 更新进度（index=10）
   ⑤ 获取进度（应该显示index=10）
   ⑥ 查看所有进度
   ⑦ 查看最近学习
   ⑧ 重置进度
   ⑨ 再次获取（应该为空）
   ```

---

## 💡 前端集成示例

### Vue/React 示例

```javascript
// 1. 进入题库页面
async mounted() {
  const bankId = this.$route.params.id;
  
  // 获取题库解析结果
  const parseResult = await this.getParseResult(bankId);
  this.questions = parseResult.questions;
  this.totalQuestions = parseResult.total_questions;
  
  // 获取学习进度
  const progress = await this.getUserProgress(bankId);
  
  if (progress) {
    // 有进度，跳转到上次位置
    this.currentIndex = progress.current_question_index;
    this.completedCount = progress.completed_count;
    
    this.$message.success(`继续学习，进度: ${progress.progress_percentage}%`);
  } else {
    // 无进度，从头开始
    this.currentIndex = 0;
    this.completedCount = 0;
    
    this.$message.info('开始新的学习');
  }
}

// 2. 答题后保存进度
async onAnswerSubmit() {
  // ... 验证答案逻辑
  
  // 更新进度
  this.currentIndex++;
  this.completedCount++;
  
  // 保存到服务器
  await this.saveProgress(this.bankId, {
    current_question_index: this.currentIndex,
    completed_count: this.completedCount,
    total_questions: this.totalQuestions
  });
  
  // 跳转下一题或完成
  if (this.currentIndex < this.totalQuestions) {
    this.showNextQuestion();
  } else {
    this.showCompleteScreen();
  }
}

// 3. API 方法封装
async getUserProgress(bankId) {
  const res = await axios.get(`/api/user-progress/${bankId}`);
  return res.data.data;
}

async saveProgress(bankId, data) {
  const res = await axios.post(`/api/user-progress/${bankId}`, data);
  return res.data.data;
}
```

### 微信小程序示例

```javascript
// 进入题库页面
onLoad(options) {
  const bankId = options.id;
  
  // 获取进度
  wx.request({
    url: `${baseUrl}/api/user-progress/${bankId}`,
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('token')}`
    },
    success: (res) => {
      if (res.data.data) {
        // 有进度
        this.setData({
          currentIndex: res.data.data.current_question_index,
          progress: res.data.data.progress_percentage
        });
        
        wx.showToast({
          title: `继续学习 ${res.data.data.progress_percentage}%`,
          icon: 'none'
        });
      }
    }
  });
}

// 保存进度
saveProgress() {
  wx.request({
    url: `${baseUrl}/api/user-progress/${this.data.bankId}`,
    method: 'POST',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('token')}`,
      'Content-Type': 'application/json'
    },
    data: {
      current_question_index: this.data.currentIndex,
      completed_count: this.data.completedCount,
      total_questions: this.data.totalQuestions
    }
  });
}
```

---

## ✅ 验证清单

- [ ] 数据表已创建（检查数据库）
- [ ] 首次获取进度返回null
- [ ] 保存进度成功
- [ ] 再次获取显示正确进度
- [ ] 更新进度成功
- [ ] 进度百分比计算正确
- [ ] 查看所有进度列表
- [ ] 查看最近学习题库
- [ ] 重置进度成功
- [ ] 唯一约束生效（同一用户+题库只有一条记录）

---

## 🔧 故障排查

### 问题1: 404 Not Found
**原因**: 路由未注册  
**检查**: `app.ts` 中是否有 `app.use('/api/user-progress', userProgressRoutes)`

### 问题2: 401 Unauthorized
**原因**: Token无效  
**解决**: 重新登录获取新Token

### 问题3: 进度不更新
**原因**: 参数错误  
**检查**: 确保传递了 `current_question_index` 和 `total_questions`

### 问题4: 数据表不存在
**原因**: 服务器未重启或数据库迁移失败  
**解决**: 重启服务器，检查日志

---

## 📊 数据库检查

```sql
-- 查看表结构
DESC user_study_progress;

-- 查看所有进度记录
SELECT * FROM user_study_progress;

-- 查看某用户的进度
SELECT * FROM user_study_progress WHERE user_id = 1;

-- 查看某题库的学习人数
SELECT COUNT(*) FROM user_study_progress WHERE bank_id = 2;
```

---

**创建时间**: 2025-10-26  
**功能状态**: ✅ 已完成  
**测试状态**: 待测试

