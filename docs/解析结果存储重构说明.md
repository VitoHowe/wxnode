# 解析结果存储结构重构说明

## 修改概述

将原有的单题目记录存储方式改为整体解析结果存储，每次解析创建一条记录，将所有题目以JSON格式存储。

## 修改日期

2025-10-19

## 背景

**原设计问题**：
- `questions` 表中每个题目单独一条记录
- 每次解析会插入大量记录
- 难以追溯每次解析的完整结果
- 数据碎片化，不便于管理

**新设计优势**：
- 每次解析创建一条记录
- 完整保留解析结果的原始数据
- 便于追溯和审计
- 减少数据库写入操作
- JSON格式灵活，支持复杂结构

## 数据库变更

### 删除旧表

```sql
DROP TABLE IF EXISTS `questions`;
```

### 创建新表 `parse_results`

```sql
CREATE TABLE `parse_results` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT '主键',
  `bank_id` INT NOT NULL COMMENT '关联的题库ID',
  `questions` JSON NOT NULL COMMENT '解析得到的题目数组(JSON格式)',
  `total_questions` INT NOT NULL DEFAULT 0 COMMENT '题目总数',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  INDEX `idx_bank_id` (`bank_id`),
  INDEX `idx_created_at` (`created_at`),
  CONSTRAINT `fk_parse_results_bank_id` FOREIGN KEY (`bank_id`) 
    REFERENCES `question_banks` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='解析结果表';
```

### 表结构说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| bank_id | INT | 关联的题库ID |
| questions | JSON | 题目数组，JSON格式存储 |
| total_questions | INT | 题目总数 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### questions JSON 格式示例

```json
[
  {
    "type": "single",
    "content": "题目内容",
    "options": ["选项A", "选项B", "选项C", "选项D"],
    "answer": "A",
    "explanation": "解析内容",
    "difficulty": 1,
    "tags": ["标签1", "标签2"]
  },
  {
    "type": "multiple",
    "content": "题目内容2",
    "options": ["选项A", "选项B", "选项C", "选项D"],
    "answer": "AB",
    "explanation": "解析内容",
    "difficulty": 2,
    "tags": ["标签1"]
  }
]
```

## 代码修改

### 1. 修改 `fileService.ts`

**修改方法**：`saveQuestions()`

```typescript
// 原方法：逐个插入questions表
private async saveQuestions(bankId: number, questions: ParsedQuestion[]): Promise<void> {
  for (const question of questions) {
    await query(
      `INSERT INTO questions (bank_id, type, content, options, answer, explanation, difficulty, tags, created_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, NOW())`,
      [...]
    );
  }
}

// 新方法：整体插入parse_results表
private async saveQuestions(bankId: number, questions: ParsedQuestion[]): Promise<void> {
  try {
    await query(
      `INSERT INTO parse_results (bank_id, questions, total_questions, created_at, updated_at)
       VALUES (?, ?, ?, NOW(), NOW())`,
      [
        bankId,
        JSON.stringify(questions),
        questions.length,
      ]
    );
    
    logger.info(`保存解析结果成功: BankID=${bankId}, TotalQuestions=${questions.length}`);
  } catch (error) {
    logger.error('保存解析结果失败:', error);
    throw error;
  }
}
```

### 2. 新增 `parseResultService.ts`

提供解析结果的完整CRUD操作：

- `getParseResults()` - 获取解析结果列表（支持分页、筛选）
- `getParseResultById()` - 根据ID获取解析结果
- `getParseResultsByBankId()` - 根据题库ID获取所有解析结果
- `deleteParseResult()` - 删除解析结果
- `getBankParseStats()` - 获取题库的解析统计信息

### 3. 新增 `parseResultController.ts`

提供HTTP API接口处理：

- 获取解析结果列表
- 获取单个解析结果
- 获取题库的所有解析结果
- 删除解析结果
- 获取统计信息

### 4. 新增路由 `parseResults.ts`

定义API端点：

- `GET /api/parse-results` - 获取解析结果列表
- `GET /api/parse-results/:id` - 获取单个解析结果
- `GET /api/parse-results/bank/:bankId` - 获取题库的所有解析结果
- `GET /api/parse-results/bank/:bankId/stats` - 获取题库统计
- `DELETE /api/parse-results/:id` - 删除解析结果

### 5. 注册路由到 `app.ts`

```typescript
import parseResultRoutes from '@/routes/parseResults';
app.use('/api/parse-results', parseResultRoutes);
```

## API使用示例

### 1. 获取解析结果列表

```http
GET /api/parse-results?bank_id=1&page=1&limit=20
Authorization: Bearer <token>

Response:
{
  "code": 200,
  "message": "获取解析结果列表成功",
  "data": {
    "results": [
      {
        "id": 1,
        "bank_id": 1,
        "questions": [...],
        "total_questions": 50,
        "created_at": "2025-10-19 10:00:00",
        "updated_at": "2025-10-19 10:00:00",
        "bank_name": "题库名称",
        "file_name": "test.pdf"
      }
    ],
    "total": 1,
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 1,
      "totalPages": 1
    }
  }
}
```

### 2. 获取单个解析结果

```http
GET /api/parse-results/1
Authorization: Bearer <token>

Response:
{
  "code": 200,
  "message": "获取解析结果成功",
  "data": {
    "id": 1,
    "bank_id": 1,
    "questions": [
      {
        "type": "single",
        "content": "题目内容",
        "options": ["A", "B", "C", "D"],
        "answer": "A",
        "explanation": "解析",
        "difficulty": 1,
        "tags": ["标签"]
      }
    ],
    "total_questions": 50,
    "created_at": "2025-10-19 10:00:00"
  }
}
```

### 3. 获取题库统计

```http
GET /api/parse-results/bank/1/stats
Authorization: Bearer <token>

Response:
{
  "code": 200,
  "message": "获取题库解析统计成功",
  "data": {
    "parse_count": 3,
    "total_questions": 150,
    "last_parse_time": "2025-10-19 10:00:00"
  }
}
```

## 数据迁移步骤

### 方式一：直接执行SQL脚本

```bash
mysql -u root -p wxnode_db < migrations/redesign_questions_table.sql
```

### 方式二：通过数据库客户端

1. 打开 Navicat / MySQL Workbench / phpMyAdmin
2. 选择 `wxnode_db` 数据库
3. 执行 `migrations/redesign_questions_table.sql` 文件

## 注意事项

⚠️ **数据丢失警告**：执行迁移脚本会删除现有的 `questions` 表及其数据

⚠️ **备份建议**：执行前建议备份数据库

⚠️ **依赖清理**：如果其他服务依赖 `questions` 表，需要同步修改

⚠️ **前端调整**：前端可能需要调整相关API调用

## 测试建议

1. **数据写入测试**：上传文件并解析，验证数据正确存入 `parse_results` 表
2. **查询测试**：调用各个查询接口，验证数据正确返回
3. **JSON解析测试**：验证 questions JSON 字段能正确解析
4. **关联查询测试**：验证与 `question_banks` 表的关联查询
5. **删除测试**：验证级联删除（删除题库时同步删除解析结果）

## 未来扩展

### 可能的扩展功能

1. **历史版本对比**：对比同一文件的不同解析结果
2. **解析质量评分**：根据AI返回的confidence等信息评估解析质量
3. **题目去重**：跨多个解析结果进行题目去重
4. **解析结果合并**：合并多个解析结果到一个题库
5. **导出功能**：将解析结果导出为Excel、PDF等格式

## 版本信息

- 修改日期：2025-10-19
- 修改人：Cascade AI
- 版本：v3.0
- 影响范围：数据库结构、后端服务、API接口
