# 解析结果接口测试指南

## 修复内容
修复了 SQL 参数传递问题，确保 `limit` 和 `offset` 参数正确转换为整数类型。

## 快速测试

### 1. 获取解析结果列表（无筛选）

**请求**:
```bash
GET /api/parse-results?page=1&limit=20
Authorization: Bearer <your_token>
```

**预期结果**:
- 状态码: 200
- 返回解析结果列表
- 包含分页信息

**测试用 cURL**:
```bash
curl -X GET "http://localhost:3001/api/parse-results?page=1&limit=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2. 获取解析结果列表（按题库筛选）

**请求**:
```bash
GET /api/parse-results?bank_id=2&page=1&limit=10
Authorization: Bearer <your_token>
```

**预期结果**:
- 状态码: 200
- 只返回 bank_id=2 的解析结果

**测试用 cURL**:
```bash
curl -X GET "http://localhost:3001/api/parse-results?bank_id=2&page=1&limit=10" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 获取单个解析结果

**请求**:
```bash
GET /api/parse-results/5
Authorization: Bearer <your_token>
```

**预期结果**:
- 状态码: 200
- 返回完整的解析结果详情，包含所有题目

**测试用 cURL**:
```bash
curl -X GET "http://localhost:3001/api/parse-results/5" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4. 获取题库的所有解析结果

**请求**:
```bash
GET /api/parse-results/bank/2
Authorization: Bearer <your_token>
```

**预期结果**:
- 状态码: 200
- 返回题库2的所有历史解析记录

**测试用 cURL**:
```bash
curl -X GET "http://localhost:3001/api/parse-results/bank/2" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 5. 获取题库统计

**请求**:
```bash
GET /api/parse-results/bank/2/stats
Authorization: Bearer <your_token>
```

**预期结果**:
- 状态码: 200
- 返回统计信息：parse_count, total_questions, last_parse_time

**测试用 cURL**:
```bash
curl -X GET "http://localhost:3001/api/parse-results/bank/2/stats" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 6. 删除解析结果

**请求**:
```bash
DELETE /api/parse-results/5
Authorization: Bearer <your_token>
```

**预期结果**:
- 状态码: 200
- 成功删除记录

**测试用 cURL**:
```bash
curl -X DELETE "http://localhost:3001/api/parse-results/5" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 常见错误处理

### 错误 1: Incorrect arguments to mysqld_stmt_execute
**原因**: SQL 参数类型不匹配
**解决**: 已修复 ✅ - 确保 limit 和 offset 是整数

### 错误 2: 401 Unauthorized
**原因**: Token 无效或过期
**解决**: 重新登录获取新 Token

### 错误 3: 404 Not Found
**原因**: 解析结果不存在
**解决**: 检查 ID 是否正确

### 错误 4: 路由冲突
**原因**: `/bank/:bankId` 被 `/:id` 提前匹配
**解决**: 已修复 ✅ - 优化了路由顺序

## Postman/Apifox 测试集合

### 环境变量
```json
{
  "base_url": "http://localhost:3001",
  "token": "your_jwt_token_here"
}
```

### 请求示例（Postman/Apifox）

#### 1. 获取列表
- Method: GET
- URL: `{{base_url}}/api/parse-results?page=1&limit=20`
- Headers:
  - Authorization: `Bearer {{token}}`

#### 2. 获取详情
- Method: GET
- URL: `{{base_url}}/api/parse-results/5`
- Headers:
  - Authorization: `Bearer {{token}}`

#### 3. 获取题库解析结果
- Method: GET
- URL: `{{base_url}}/api/parse-results/bank/2`
- Headers:
  - Authorization: `Bearer {{token}}`

#### 4. 获取题库统计
- Method: GET
- URL: `{{base_url}}/api/parse-results/bank/2/stats`
- Headers:
  - Authorization: `Bearer {{token}}`

#### 5. 删除解析结果
- Method: DELETE
- URL: `{{base_url}}/api/parse-results/5`
- Headers:
  - Authorization: `Bearer {{token}}`

## JavaScript 测试代码

```javascript
const baseUrl = 'http://localhost:3001';
const token = 'YOUR_TOKEN';

// 1. 获取解析结果列表
async function testGetList() {
  const response = await fetch(`${baseUrl}/api/parse-results?page=1&limit=20`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  const data = await response.json();
  console.log('列表:', data);
}

// 2. 获取单个解析结果
async function testGetById(id) {
  const response = await fetch(`${baseUrl}/api/parse-results/${id}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  const data = await response.json();
  console.log('详情:', data);
}

// 3. 获取题库的解析结果
async function testGetByBankId(bankId) {
  const response = await fetch(`${baseUrl}/api/parse-results/bank/${bankId}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  const data = await response.json();
  console.log('题库解析结果:', data);
}

// 4. 获取题库统计
async function testGetStats(bankId) {
  const response = await fetch(`${baseUrl}/api/parse-results/bank/${bankId}/stats`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  const data = await response.json();
  console.log('统计信息:', data);
}

// 5. 删除解析结果
async function testDelete(id) {
  const response = await fetch(`${baseUrl}/api/parse-results/${id}`, {
    method: 'DELETE',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  const data = await response.json();
  console.log('删除结果:', data);
}

// 运行测试
(async () => {
  await testGetList();
  // await testGetById(5);
  // await testGetByBankId(2);
  // await testGetStats(2);
  // await testDelete(5);
})();
```

## 验证清单

- [ ] 获取解析结果列表（无筛选）- 200 OK
- [ ] 获取解析结果列表（按题库筛选）- 200 OK
- [ ] 获取单个解析结果详情 - 200 OK
- [ ] 获取题库的所有解析结果 - 200 OK
- [ ] 获取题库统计信息 - 200 OK
- [ ] 删除解析结果 - 200 OK
- [ ] 路由冲突测试 - /bank/2 不会被误认为 /:id
- [ ] 参数类型测试 - limit 和 offset 正确转换
- [ ] 错误处理测试 - 404/401 等错误正确返回

## 预期响应示例

### 成功响应（列表）
```json
{
  "code": 200,
  "message": "获取解析结果列表成功",
  "data": {
    "results": [...],
    "total": 8,
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 8,
      "totalPages": 1
    }
  }
}
```

### 成功响应（详情）
```json
{
  "code": 200,
  "message": "获取解析结果成功",
  "data": {
    "id": 5,
    "bank_id": 2,
    "questions": [...],
    "total_questions": 50,
    "created_at": "2025-10-26 10:30:45",
    "bank_name": "前端开发题库",
    "file_name": "frontend_questions.pdf"
  }
}
```

### 错误响应
```json
{
  "code": 404,
  "message": "解析结果不存在",
  "data": null
}
```

## 注意事项

1. **Token 获取**：先调用登录接口获取有效的 JWT Token
2. **测试顺序**：建议先测试查询接口，最后测试删除接口
3. **数据准备**：确保数据库中有测试数据（通过文件上传和解析创建）
4. **路由测试**：特别注意测试 `/bank/:bankId` 和 `/:id` 的路由匹配是否正确

---

**测试完成后请反馈结果** ✅

