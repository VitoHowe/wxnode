# 数据库自动迁移说明

## 概述

系统在启动时会自动检查并创建所需的数据库表结构，同时处理旧版本表的数据迁移。

## 修改日期

2025-10-20

## 自动创建的表

### 1. `parse_results` 表（✨ 新增）

**用途**：存储AI解析的完整结果

**表结构**：
```sql
CREATE TABLE IF NOT EXISTS parse_results (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',
  bank_id INT NOT NULL COMMENT '关联的题库ID',
  questions JSON NOT NULL COMMENT '解析得到的题目数组(JSON格式)',
  total_questions INT NOT NULL DEFAULT 0 COMMENT '题目总数',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_bank_id (bank_id),
  INDEX idx_created_at (created_at),
  CONSTRAINT fk_parse_results_bank_id FOREIGN KEY (bank_id) 
    REFERENCES question_banks(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='解析结果表';
```

**字段说明**：
- `id`: 主键
- `bank_id`: 关联 `question_banks` 表的ID
- `questions`: JSON数组，存储所有题目的完整数据
- `total_questions`: 题目总数
- `created_at`: 创建时间
- `updated_at`: 更新时间

**questions JSON 格式**：
```json
[
  {
    "type": "single",
    "content": "题目内容",
    "options": ["A", "B", "C", "D"],
    "answer": "A",
    "explanation": "解析内容",
    "difficulty": 1,
    "tags": ["标签1", "标签2"],
    "page_number": 1,
    "confidence_score": 0.95
  }
]
```

### 2. 其他表

系统启动时还会自动创建/检查以下表：
- `roles` - 角色表
- `users` - 用户表
- `question_banks` - 题库表
- `parse_logs` - 解析日志表
- `ai_providers` - AI供应商配置表
- `system_settings` - 系统设置表

## 自动数据迁移

### 从 `questions` 表迁移到 `parse_results` 表

**触发条件**：检测到旧的 `questions` 表存在

**迁移步骤**：

1. **检查旧表**
   ```sql
   SELECT TABLE_NAME 
   FROM INFORMATION_SCHEMA.TABLES 
   WHERE TABLE_NAME = 'questions'
   ```

2. **统计数据量**
   ```sql
   SELECT COUNT(*) as count FROM questions
   ```

3. **按题库聚合数据**
   ```sql
   SELECT 
     bank_id,
     JSON_ARRAYAGG(
       JSON_OBJECT(
         'type', type,
         'content', content,
         'options', options,
         'answer', answer,
         'explanation', explanation,
         'difficulty', difficulty,
         'tags', tags,
         'page_number', page_number,
         'confidence_score', confidence_score
       )
     ) as questions,
     COUNT(*) as total_questions,
     MIN(created_at) as created_at
   FROM questions
   GROUP BY bank_id
   ```

4. **插入到新表**
   ```sql
   INSERT INTO parse_results (bank_id, questions, total_questions, created_at, updated_at)
   VALUES (?, ?, ?, ?, NOW())
   ```

5. **备份旧表**
   ```sql
   RENAME TABLE questions TO questions_backup_[timestamp]
   ```

**迁移日志示例**：
```
[2025-10-20 23:00:00] 检测到旧的questions表，开始迁移数据到parse_results表...
[2025-10-20 23:00:01] 发现 150 条题目记录，开始迁移...
[2025-10-20 23:00:02] 成功迁移 5 个题库的数据到parse_results表
[2025-10-20 23:00:02] 旧questions表已重命名为: questions_backup_1729436402123
```

## 字段迁移

### `question_banks` 表字段迁移

系统会自动检查并添加以下字段（如果不存在）：

1. **file_type** - 文件类型字段
   ```sql
   ALTER TABLE question_banks 
   ADD COLUMN file_type ENUM('question_bank', 'knowledge_base') 
   DEFAULT 'question_bank' COMMENT '文件类型：题库/知识库'
   ```

2. **provider_id** - AI供应商ID
   ```sql
   ALTER TABLE question_banks 
   ADD COLUMN provider_id INT NULL COMMENT 'AI供应商ID'
   ```

3. **model_name** - AI模型名称
   ```sql
   ALTER TABLE question_banks 
   ADD COLUMN model_name VARCHAR(100) NULL COMMENT 'AI模型名称'
   ```

### `users` 表字段迁移

自动添加普通用户登录所需字段：

1. **username** - 用户名
   ```sql
   ALTER TABLE users 
   ADD COLUMN username VARCHAR(50) UNIQUE NULL COMMENT '用户名，微信用户为空'
   ```

2. **password** - 密码hash
   ```sql
   ALTER TABLE users 
   ADD COLUMN password VARCHAR(255) NULL COMMENT '密码hash，微信用户为空'
   ```

## 启动流程

```
应用启动
    ↓
连接MySQL服务器
    ↓
创建数据库（如果不存在）
    ↓
创建所有表（IF NOT EXISTS）
    ↓
执行字段迁移
    ↓
执行数据迁移
    ↓
初始化默认数据
    ↓
启动完成
```

## 安全性

### 数据安全保证

1. ✅ **非破坏性** - 旧表会被重命名为备份，而不是删除
2. ✅ **幂等性** - 多次运行迁移脚本不会重复处理
3. ✅ **事务支持** - 单个迁移失败不影响其他迁移
4. ✅ **日志记录** - 详细记录迁移过程和结果

### 备份建议

虽然系统会自动备份旧表，但建议在首次运行前：

```bash
# 备份整个数据库
mysqldump -u root -p wxnode_db > backup_$(date +%Y%m%d_%H%M%S).sql

# 或只备份questions表
mysqldump -u root -p wxnode_db questions > questions_backup_$(date +%Y%m%d_%H%M%S).sql
```

## 回滚方案

如果需要回滚到旧版本：

```sql
-- 1. 删除新表
DROP TABLE IF EXISTS parse_results;

-- 2. 恢复旧表（找到对应的备份表）
RENAME TABLE questions_backup_[timestamp] TO questions;

-- 3. 重启应用
```

## 监控和验证

### 验证迁移成功

```sql
-- 检查parse_results表是否创建
SHOW TABLES LIKE 'parse_results';

-- 检查数据是否迁移
SELECT 
  pr.id,
  pr.bank_id,
  pr.total_questions,
  qb.name as bank_name
FROM parse_results pr
LEFT JOIN question_banks qb ON pr.bank_id = qb.id;

-- 查看备份表
SHOW TABLES LIKE 'questions_backup_%';
```

### 数据一致性检查

```sql
-- 对比迁移前后的数据量
-- 旧表总记录数
SELECT COUNT(*) FROM questions_backup_[timestamp];

-- 新表总题目数
SELECT SUM(total_questions) FROM parse_results;
```

## 常见问题

### Q: 迁移失败怎么办？

A: 迁移失败不会阻止应用启动，会记录错误日志。可以：
1. 查看日志了解失败原因
2. 手动执行迁移SQL
3. 联系技术支持

### Q: 已有数据会丢失吗？

A: 不会。旧表会被重命名为 `questions_backup_[timestamp]`，数据完整保留。

### Q: 能否跳过迁移？

A: 迁移检测是自动的，如果检测不到旧表会跳过。可以手动删除或重命名旧表来避免迁移。

### Q: 迁移需要多长时间？

A: 取决于数据量：
- 1000条记录：< 1秒
- 10000条记录：< 5秒
- 100000条记录：< 30秒

## 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v3.0 | 2025-10-20 | 新增parse_results表，废弃questions表 |
| v2.5 | 2025-10-19 | 添加AI供应商配置相关字段 |
| v2.0 | 2025-10-18 | 添加用户名密码登录支持 |
| v1.0 | 2025-10-15 | 初始版本 |

## 技术支持

如遇到数据库迁移问题，请：
1. 查看启动日志 - 查找 "数据库连接成功" 前的所有日志
2. 备份数据库 - 执行上述备份命令
3. 提供错误信息 - 包括完整的错误堆栈
4. 查看备份表 - 确认数据是否安全

---

**最后更新**：2025-10-20  
**维护者**：Cascade AI  
**版本**：v3.0
