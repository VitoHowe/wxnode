# 图片资源管理指南

## 概述

题目中的图片使用 `${images/xxx.jpg}` 格式引用。系统会自动将其转换为可访问的URL。

## 目录结构

```
wxnode/
└── public/
    └── question-banks/
        ├── 15/                    # 题库ID
        │   └── images/
        │       ├── 909c1f56...jpg
        │       └── ce4de73...jpg
        └── 16/                    # 另一个题库
            └── images/
```

## 图片引用格式

### 题目JSON中的格式
```json
{
  "question": "44",
  "content": "数据仓库...如下图所示：\n\n${images/909c1f56d7d2117316d5d97a0ff576c139cf8d320652e1114e3ce90a77de33f0.jpg}",
  "explanation": "P47,\n\n${images/ce4de732109ab9da0bc34a144a5519bcbd34adeb3276b5cdea48eac9b1e2f040.jpg}"
}
```

### 前端访问URL
```
http://localhost:3001/api/question-banks/15/images/909c1f56d7d2117316d5d97a0ff576c139cf8d320652e1114e3ce90a77de33f0.jpg
```

## 使用步骤

### 1. 准备图片文件

将题库的图片文件放入对应目录：

```bash
# Windows
mkdir public\question-banks\15\images
copy *.jpg public\question-banks\15\images\

# Linux/Mac
mkdir -p public/question-banks/15/images
cp *.jpg public/question-banks/15/images/
```

### 2. 前端图片解析

#### 方式A：前端解析（推荐）

```javascript
// utils/imageParser.js
export function parseQuestionImages(question, bankId) {
  const baseUrl = 'http://localhost:3001'; // 或从配置读取
  
  // 替换 content 中的图片
  if (question.content) {
    question.content = question.content.replace(
      /\$\{images\/([^}]+)\}/g,
      (match, filename) => `${baseUrl}/api/question-banks/${bankId}/images/${filename}`
    );
  }
  
  // 替换 explanation 中的图片
  if (question.explanation) {
    question.explanation = question.explanation.replace(
      /\$\{images\/([^}]+)\}/g,
      (match, filename) => `${baseUrl}/api/question-banks/${bankId}/images/${filename}`
    );
  }
  
  return question;
}

// 使用示例
const question = parseQuestionImages(responseData.question, 15);
```

#### 方式B：后端自动替换

在 `questionService.ts` 中添加自动替换（需要知道bankId）：

```typescript
import { replaceQuestionImages } from '@/utils/imageParser';

// 返回前处理
const question = replaceQuestionImages(rawQuestion, bankId);
```

### 3. 前端渲染图片

#### React示例

```jsx
import { parseQuestionImages } from '@/utils/imageParser';

function QuestionCard({ question, bankId }) {
  const parsed = parseQuestionImages(question, bankId);
  
  return (
    <div>
      {/* 使用 dangerouslySetInnerHTML 或 markdown 渲染 */}
      <div dangerouslySetInnerHTML={{ __html: parsed.content }} />
      
      {/* 或使用 markdown-it */}
      <ReactMarkdown>{parsed.content}</ReactMarkdown>
    </div>
  );
}
```

#### 微信小程序示例

```javascript
// pages/question/question.js
Page({
  data: {
    question: null,
    richTextNodes: []
  },
  
  onLoad: function(options) {
    const { bankId, questionNumber } = options;
    this.loadQuestion(bankId, questionNumber);
  },
  
  loadQuestion: async function(bankId, questionNumber) {
    const res = await wx.request({
      url: `${API_BASE}/api/question-banks/${bankId}/chapters/1/questions`,
      data: { questionNumber }
    });
    
    const question = res.data.data.question;
    
    // 解析图片URL
    const content = this.parseImages(question.content, bankId);
    
    // 转换为 rich-text 节点
    const nodes = this.htmlToNodes(content);
    
    this.setData({
      question,
      richTextNodes: nodes
    });
  },
  
  parseImages: function(text, bankId) {
    return text.replace(
      /\$\{images\/([^}]+)\}/g,
      (match, filename) => {
        return `<img src="${API_BASE}/api/question-banks/${bankId}/images/${filename}" mode="widthFix" />`;
      }
    );
  }
});
```

## 图片管理API（待实现）

### 获取题库图片列表
```bash
GET /api/question-banks/:bankId/images
```

响应：
```json
{
  "code": 200,
  "data": {
    "images": [
      {
        "filename": "909c1f56...jpg",
        "url": "/api/question-banks/15/images/909c1f56...jpg",
        "size": 125840,
        "usedInQuestions": [101, 102]
      }
    ],
    "total": 25
  }
}
```

### 上传图片
```bash
POST /api/question-banks/:bankId/images
Content-Type: multipart/form-data

image: [文件]
```

### 删除未使用的图片
```bash
DELETE /api/question-banks/:bankId/images/unused
```

## 批量导入时的图片处理

上传JSON文件时，系统会：

1. **扫描图片引用**：提取所有 `${images/xxx}` 引用
2. **生成图片清单**：列出需要的图片文件名
3. **检查文件是否存在**：标记缺失的图片
4. **返回导入报告**：
   ```json
   {
     "importedQuestions": 50,
     "imagesFound": 15,
     "imagesMissing": ["xxx.jpg", "yyy.jpg"]
   }
   ```

## 注意事项

1. ✅ 图片文件名应使用hash值，避免重名
2. ✅ 建议图片文件大小控制在500KB以内
3. ✅ 支持格式：jpg, jpeg, png, gif, webp
4. ⚠️ 删除题库时不会自动删除图片，需手动清理
5. ⚠️ 图片URL在题目返回时动态生成，不存储在数据库

## 工具函数

已提供的工具函数（`src/utils/imageParser.ts`）：

- `extractImageReferences(text)` - 提取文本中的图片引用
- `replaceImageReferences(text, bankId, baseUrl)` - 替换图片引用为URL
- `extractQuestionImages(question)` - 提取题目中的所有图片
- `replaceQuestionImages(question, bankId, baseUrl)` - 替换题目中的图片引用

## 示例：完整流程

### 1. 上传题库JSON
```bash
POST /api/files/upload-json
```

### 2. 系统返回图片清单
```json
{
  "bankId": 15,
  "imagesMissing": [
    "909c1f56d7d2117316d5d97a0ff576c139cf8d320652e1114e3ce90a77de33f0.jpg",
    "ce4de732109ab9da0bc34a144a5519bcbd34adeb3276b5cdea48eac9b1e2f040.jpg"
  ]
}
```

### 3. 手动上传图片到目录
```bash
copy images\*.jpg public\question-banks\15\images\
```

### 4. 前端获取题目
```bash
GET /api/question-banks/15/chapters/1/questions?questionNumber=1
```

### 5. 前端解析并渲染
```javascript
const question = parseQuestionImages(data.question, 15);
// 图片URL已转换为: http://localhost:3001/api/question-banks/15/images/xxx.jpg
```

## 未来优化

- [ ] 实现图片上传API
- [ ] 自动检测缺失图片
- [ ] 图片压缩和优化
- [ ] CDN集成
- [ ] 图片懒加载
- [ ] 图片预览和管理界面
