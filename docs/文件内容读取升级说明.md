# 文件内容读取功能升级说明

## 概述

本次升级针对文件解析功能进行了重大改进，支持根据不同AI提供商的API要求，以不同格式处理文件内容（特别是图片和PDF文件）。

## 主要改进

### 1. 新增文件内容读取器 (`FileContentReader`)

创建了 `src/utils/fileContentReader.ts`，提供统一的文件内容读取接口：

- **支持的文件类型**：
  - 文本文件：`.txt`, `.md`, `.json`, `.csv`
  - 图片文件：`.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`, `.webp`
  - PDF文件：`.pdf`

- **根据Provider类型返回不同格式**：
  - **OpenAI/Qwen格式**：
    - 图片 → base64编码
    - PDF → base64编码（未来将升级为PDF每页转JPG再转base64）
  - **Gemini格式**：
    - 图片 → base64编码
    - PDF → 直接base64编码

### 2. 更新解析策略

修改了所有解析策略类以支持新的文件内容格式：

#### BaseParseStrategy
- 修改 `parseFile` 方法签名，接收 `FileContentResult` 而非简单的字符串
- 更新 `buildUserPrompt` 方法以处理不同类型的内容

#### OpenAIParseStrategy
- 新增 `buildUserMessage` 方法
- 支持发送base64编码的图片和PDF到OpenAI API
- 使用 `image_url` 格式传递图片数据

#### GeminiParseStrategy
- 新增 `buildParts` 方法
- 支持发送base64编码的图片和PDF到Gemini API
- 使用 `inline_data` 格式传递图片数据

#### QwenParseStrategy
- 新增 `buildUserMessage` 方法
- 采用类似OpenAI的格式处理图片和PDF

### 3. 更新文件上传配置

在 `src/routes/files.ts` 中：
- 添加了图片文件类型的支持（JPG, PNG, GIF, BMP, WEBP）
- 更新了文件过滤器和Swagger文档

### 4. 修改FileService

在 `src/services/fileService.ts` 中：
- 移除了旧的 `readFileContent` 方法
- 在 `executeAIParseTask` 中使用新的 `FileContentReader`
- 根据provider类型自动选择正确的文件处理方式

## 使用示例

### 文本文件
```typescript
const result = await FileContentReader.readFileContent('/path/to/file.txt', 'openai');
// result.type === 'text'
// result.content === "文件的文本内容"
```

### 图片文件
```typescript
const result = await FileContentReader.readFileContent('/path/to/image.jpg', 'openai');
// result.type === 'base64'
// result.content === "base64编码的图片数据"
// result.mimeType === 'image/jpeg'
```

### PDF文件（OpenAI）
```typescript
const result = await FileContentReader.readFileContent('/path/to/file.pdf', 'openai');
// result.type === 'base64'
// result.content === "base64编码的PDF数据"
// result.mimeType === 'application/pdf'
```

### PDF文件（Gemini）
```typescript
const result = await FileContentReader.readFileContent('/path/to/file.pdf', 'gemini');
// result.type === 'base64'
// result.content === "base64编码的PDF数据"
// result.mimeType === 'application/pdf'
```

## ✅ 已实现：PDF转图片功能

### 实现细节

使用 `pdf-to-img` 库实现了真正的PDF转图片功能：

1. **依赖安装**：
```bash
npm install pdf-to-img
```

2. **功能特性**：
   - ✅ 将PDF的每一页转换为PNG图片
   - ✅ 每张图片转换为base64
   - ✅ 返回base64数组（`type: 'base64_array'`）
   - ✅ 单页PDF自动优化为单个base64（`type: 'base64'`）
   - ✅ 转换失败时自动降级为PDF直接base64

3. **优势**：
   - ✅ 更好地处理图片式PDF
   - ✅ 提高OCR识别准确率
   - ✅ 支持逐页解析
   - ✅ 纯JavaScript实现，无需外部依赖
   - ✅ 高分辨率输出（scale: 2.0）

### 转换配置

```typescript
const document = await pdf(filePath, {
  scale: 2.0, // 提高分辨率以获得更好的OCR效果
});
```

### 错误处理

如果PDF转图片失败，系统会自动降级为直接返回PDF的base64格式，确保功能的健壮性。

## 注意事项

1. **文件大小限制**：
   - base64编码会增加约33%的数据大小
   - 建议设置合理的文件大小限制（当前为50MB）

2. **性能考虑**：
   - 大文件的base64转换可能消耗较多内存
   - PDF转图片功能将需要更多的处理时间

3. **API兼容性**：
   - 确保使用的AI模型支持图片输入
   - OpenAI的vision模型（如gpt-4-vision-preview）支持图片
   - Gemini的某些模型原生支持PDF

4. **错误处理**：
   - 文件读取失败会抛出异常
   - 建议在调用处添加适当的错误处理

## 测试建议

1. 测试文本文件解析（确保向后兼容）
2. 测试图片文件解析（JPG, PNG等）
3. 测试PDF文件解析（文本式和图片式）
4. 测试不同provider的API调用
5. 测试大文件的处理性能

## 相关文件

- `src/utils/fileContentReader.ts` - 文件内容读取器
- `src/services/fileService.ts` - 文件服务
- `src/services/providerStrategies/parseStrategies/baseParseStrategy.ts` - 基础解析策略
- `src/services/providerStrategies/parseStrategies/openaiParseStrategy.ts` - OpenAI解析策略
- `src/services/providerStrategies/parseStrategies/geminiParseStrategy.ts` - Gemini解析策略
- `src/services/providerStrategies/parseStrategies/qwenParseStrategy.ts` - Qwen解析策略
- `src/routes/files.ts` - 文件路由配置
