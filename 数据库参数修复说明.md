# ğŸ› ï¸ æ•°æ®åº“å‚æ•°ä¿®å¤è¯´æ˜

## âŒ åŸå§‹é—®é¢˜

```
åˆ›å»ºç”¨æˆ·å¤±è´¥: Bind parameters must not contain undefined. To pass SQL NULL specify JS null
```

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜æ ¹æº
æ•°æ®åº“æŸ¥è¯¢å‚æ•°åŒ…å«äº† `undefined` å€¼ï¼Œä½†æ•°æ®åº“ç»‘å®šå‚æ•°åªæ¥å—å…·ä½“å€¼æˆ– `null`ã€‚

### å…·ä½“é—®é¢˜å‚æ•°
1. **unionid**: å¾®ä¿¡ç”¨æˆ·ä¸ä¸€å®šæœ‰unionidï¼Œå¯èƒ½ä¸º `undefined`
2. **phone**: åˆ›å»ºç”¨æˆ·æ—¶æœªæä¾›æ‰‹æœºå·ï¼Œä¸º `undefined`  
3. **session_key**: åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¸º `undefined`

### é—®é¢˜ä»£ç ç¤ºä¾‹
```typescript
// authService.ts ä¸­è°ƒç”¨createUser
user = await userService.createUser({
  openid,
  unionid,        // âŒ å¯èƒ½æ˜¯ undefined
  nickname: userInfo?.nickName || 'å¾®ä¿¡ç”¨æˆ·',
  avatar_url: userInfo?.avatarUrl || '',
  session_key: WechatUtil.encryptSensitiveData(session_key),
});

// userService.ts ä¸­çš„SQLæŸ¥è¯¢
const result = await query(sql, [openid, unionid, nickname, avatar_url, phone, role_id, session_key]);
                                      // âŒ unionidå’Œphoneå¯èƒ½æ˜¯undefined
```

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å‚æ•°å®‰å…¨è½¬æ¢
ä½¿ç”¨ç©ºå€¼åˆå¹¶æ“ä½œç¬¦ (`??`) å°† `undefined` è½¬æ¢ä¸º `null`ï¼š

```typescript
// ä¿®å¤åçš„ä»£ç 
const safeParams = [
  openid,
  unionid ?? null,           // undefined -> null
  nickname,
  avatar_url,
  phone ?? null,            // undefined -> null  
  role_id,
  session_key ?? null       // undefined -> null
];

const result = await query(sql, safeParams);
```

### 2. å¢å¼ºæ—¥å¿—è®°å½•
æ·»åŠ è¯¦ç»†çš„å‚æ•°æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•ï¼š

```typescript
logger.info('åˆ›å»ºç”¨æˆ·å‚æ•°:', { 
  openid: openid.substring(0, 8) + '***', 
  hasUnionid: !!unionid,
  nickname,
  hasSessionKey: !!session_key,
  role_id 
});
```

### 3. æ›´æ–°æ“ä½œä¼˜åŒ–
åœ¨ç”¨æˆ·æ›´æ–°æ—¶ä¹Ÿç¡®ä¿ `null` å€¼æ­£ç¡®å¤„ç†ï¼š

```typescript
Object.entries(params).forEach(([key, value]) => {
  if (value !== undefined) {
    updateFields.push(`${key} = ?`);
    // ç¡®ä¿nullå€¼æ­£ç¡®ä¼ é€’ç»™æ•°æ®åº“
    updateValues.push(value === null ? null : value);
  }
});
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
âŒ åˆ›å»ºç”¨æˆ·å¤±è´¥: Bind parameters must not contain undefined
âŒ ç”¨æˆ·æ— æ³•æ³¨å†Œ
âŒ å¾®ä¿¡ç™»å½•æµç¨‹ä¸­æ–­
```

### ä¿®å¤å
```
âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ: ID=1, openid=oilbe4s3***
âœ… å¾®ä¿¡ç™»å½•æµç¨‹å®Œæ•´
âœ… æ•°æ®åº“å‚æ•°æ­£ç¡®å¤„ç†
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### undefined vs null çš„åŒºåˆ«
- **undefined**: JavaScriptä¸­è¡¨ç¤ºæœªå®šä¹‰çš„å€¼
- **null**: è¡¨ç¤ºç©ºå€¼ï¼Œæ•°æ®åº“å¯ä»¥æ¥å—
- **æ•°æ®åº“è¦æ±‚**: ç»‘å®šå‚æ•°å¿…é¡»æ˜¯å…·ä½“å€¼æˆ– `null`ï¼Œä¸èƒ½æ˜¯ `undefined`

### æœ€ä½³å®è·µ
1. **å‰ç«¯ä¼ å‚**: ç¡®ä¿APIè°ƒç”¨æ—¶ä¼ å…¥æ­£ç¡®çš„å€¼æˆ–æ˜¾å¼çš„ `null`
2. **åç«¯å¤„ç†**: åœ¨æ•°æ®åº“æ“ä½œå‰è¿›è¡Œå‚æ•°å®‰å…¨è½¬æ¢
3. **ç±»å‹å®šä¹‰**: ä½¿ç”¨TypeScriptæ˜ç¡®åŒºåˆ†å¯é€‰å‚æ•°å’Œå¯ç©ºå€¼

```typescript
interface CreateUserParams {
  openid: string;           // å¿…éœ€
  unionid?: string;         // å¯é€‰ï¼Œä½†å¦‚æœæœ‰å€¼å°±ä¸èƒ½æ˜¯null
  nickname?: string;        // å¯é€‰
  phone?: string;           // å¯é€‰
}

// åœ¨æ•°æ®åº“æ“ä½œæ—¶è½¬æ¢
const dbParams = {
  openid: params.openid,
  unionid: params.unionid ?? null,  // è½¬æ¢è§„åˆ™
  nickname: params.nickname ?? 'å¾®ä¿¡ç”¨æˆ·',
  phone: params.phone ?? null
};
```

## ğŸš€ éªŒè¯æ­¥éª¤

1. **é‡å¯æœåŠ¡**:
   ```bash
   npm run dev
   ```

2. **æµ‹è¯•å¾®ä¿¡ç™»å½•**:
   - åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æµ‹è¯•ç™»å½•
   - æŸ¥çœ‹æ—¥å¿—æ˜¯å¦å‡ºç°ç”¨æˆ·åˆ›å»ºæˆåŠŸä¿¡æ¯

3. **æœŸæœ›ç»“æœ**:
   ```
   âœ… å¾®ä¿¡å°ç¨‹åºé…ç½®æ£€æŸ¥é€šè¿‡
   âœ… å¾®ä¿¡ç™»å½•æˆåŠŸ, openid: oilbe4s3***
   âœ… åˆ›å»ºç”¨æˆ·å‚æ•°: { openid: 'oilbe4s3***', hasUnionid: false, nickname: 'å¾®ä¿¡ç”¨æˆ·', hasSessionKey: true, role_id: 2 }
   âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ: ID=1, openid=oilbe4s3***
   ```

ç°åœ¨å¾®ä¿¡å°ç¨‹åºç™»å½•åŠŸèƒ½åº”è¯¥å®Œå…¨æ­£å¸¸äº†ï¼ğŸ‰
