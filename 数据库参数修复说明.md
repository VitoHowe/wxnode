# 🛠️ 数据库参数修复说明

## ❌ 原始问题

```
创建用户失败: Bind parameters must not contain undefined. To pass SQL NULL specify JS null
```

## 🔍 问题分析

### 问题根源
数据库查询参数包含了 `undefined` 值，但数据库绑定参数只接受具体值或 `null`。

### 具体问题参数
1. **unionid**: 微信用户不一定有unionid，可能为 `undefined`
2. **phone**: 创建用户时未提供手机号，为 `undefined`  
3. **session_key**: 在某些情况下可能为 `undefined`

### 问题代码示例
```typescript
// authService.ts 中调用createUser
user = await userService.createUser({
  openid,
  unionid,        // ❌ 可能是 undefined
  nickname: userInfo?.nickName || '微信用户',
  avatar_url: userInfo?.avatarUrl || '',
  session_key: WechatUtil.encryptSensitiveData(session_key),
});

// userService.ts 中的SQL查询
const result = await query(sql, [openid, unionid, nickname, avatar_url, phone, role_id, session_key]);
                                      // ❌ unionid和phone可能是undefined
```

## ✅ 解决方案

### 1. 参数安全转换
使用空值合并操作符 (`??`) 将 `undefined` 转换为 `null`：

```typescript
// 修复后的代码
const safeParams = [
  openid,
  unionid ?? null,           // undefined -> null
  nickname,
  avatar_url,
  phone ?? null,            // undefined -> null  
  role_id,
  session_key ?? null       // undefined -> null
];

const result = await query(sql, safeParams);
```

### 2. 增强日志记录
添加详细的参数日志，便于调试：

```typescript
logger.info('创建用户参数:', { 
  openid: openid.substring(0, 8) + '***', 
  hasUnionid: !!unionid,
  nickname,
  hasSessionKey: !!session_key,
  role_id 
});
```

### 3. 更新操作优化
在用户更新时也确保 `null` 值正确处理：

```typescript
Object.entries(params).forEach(([key, value]) => {
  if (value !== undefined) {
    updateFields.push(`${key} = ?`);
    // 确保null值正确传递给数据库
    updateValues.push(value === null ? null : value);
  }
});
```

## 📊 修复效果

### 修复前
```
❌ 创建用户失败: Bind parameters must not contain undefined
❌ 用户无法注册
❌ 微信登录流程中断
```

### 修复后
```
✅ 用户创建成功: ID=1, openid=oilbe4s3***
✅ 微信登录流程完整
✅ 数据库参数正确处理
```

## 🔧 技术细节

### undefined vs null 的区别
- **undefined**: JavaScript中表示未定义的值
- **null**: 表示空值，数据库可以接受
- **数据库要求**: 绑定参数必须是具体值或 `null`，不能是 `undefined`

### 最佳实践
1. **前端传参**: 确保API调用时传入正确的值或显式的 `null`
2. **后端处理**: 在数据库操作前进行参数安全转换
3. **类型定义**: 使用TypeScript明确区分可选参数和可空值

```typescript
interface CreateUserParams {
  openid: string;           // 必需
  unionid?: string;         // 可选，但如果有值就不能是null
  nickname?: string;        // 可选
  phone?: string;           // 可选
}

// 在数据库操作时转换
const dbParams = {
  openid: params.openid,
  unionid: params.unionid ?? null,  // 转换规则
  nickname: params.nickname ?? '微信用户',
  phone: params.phone ?? null
};
```

## 🚀 验证步骤

1. **重启服务**:
   ```bash
   npm run dev
   ```

2. **测试微信登录**:
   - 在微信开发者工具中测试登录
   - 查看日志是否出现用户创建成功信息

3. **期望结果**:
   ```
   ✅ 微信小程序配置检查通过
   ✅ 微信登录成功, openid: oilbe4s3***
   ✅ 创建用户参数: { openid: 'oilbe4s3***', hasUnionid: false, nickname: '微信用户', hasSessionKey: true, role_id: 2 }
   ✅ 用户创建成功: ID=1, openid=oilbe4s3***
   ```

现在微信小程序登录功能应该完全正常了！🎉
