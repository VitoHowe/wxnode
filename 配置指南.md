# 微信小程序题库管理系统配置指南

**版本**: v1.2.0  
**最后更新**: 2025-09-28

## 🚀 快速开始

### 1. 环境要求

- **Node.js**: >= 16.0.0
- **MySQL**: >= 8.0
- **Redis**: >= 6.0 (可选，已移除依赖)
- **pnpm**: >= 7.0 (推荐) 或 npm

### 2. 安装依赖

```bash
# 使用pnpm（推荐）
pnpm install

# 或使用npm
npm install
```

### 3. 环境配置

复制环境变量模板文件：
```bash
cp .env.example .env
```

编辑 `.env` 文件：

```env
# 🔧 服务器配置
PORT=3001
NODE_ENV=development

# 🗄️ 数据库配置（必需）
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_mysql_password
DB_NAME=wxnode_db

# 🔐 JWT配置（必需）
JWT_SECRET=your-super-secret-jwt-key-change-this
JWT_REFRESH_SECRET=your-super-secret-refresh-key-change-this

# 📱 微信小程序配置（可选）
WECHAT_APPID=your_wechat_miniprogram_appid
WECHAT_SECRET=your_wechat_miniprogram_secret

# 📦 Redis配置（可选，系统已移除Redis依赖）
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
```

## 🔑 重要配置说明

### 数据库配置
```env
DB_HOST=localhost        # 数据库主机地址
DB_PORT=3306            # 数据库端口
DB_USER=root            # 数据库用户名
DB_PASSWORD=123456      # 数据库密码
DB_NAME=wxnode_db       # 数据库名称
```

### JWT安全配置
```env
# 强烈建议更改默认密钥！
JWT_SECRET=your-unique-secret-key-2025
JWT_REFRESH_SECRET=your-unique-refresh-key-2025
```

### 微信小程序配置
```env
# 从微信公众平台获取: https://mp.weixin.qq.com/
WECHAT_APPID=wx1234567890abcdef
WECHAT_SECRET=1234567890abcdef1234567890abcdef
```

## 📊 数据库设置

### 自动初始化
系统启动时会自动：
- 创建数据库（如不存在）
- 创建所需表结构
- 执行数据库迁移
- 插入默认数据

### 手动初始化（如需要）
```bash
# 连接MySQL并创建数据库
mysql -u root -p
CREATE DATABASE wxnode_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

## 🎯 启动服务

### 开发模式
```bash
pnpm run dev
```

### 生产模式
```bash
# 构建项目
pnpm run build

# 启动服务
pnpm start
```

## 📋 功能验证

### 1. 基础健康检查
```bash
curl http://localhost:3001/health
```

预期响应：
```json
{
  "status": "OK",
  "timestamp": "2025-09-28T14:12:19.123Z",
  "version": "1.2.0"
}
```

### 2. 普通用户注册测试
```bash
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "TestPass123",
    "nickname": "测试用户"
  }'
```

### 3. 普通用户登录测试
```bash
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "TestPass123"
  }'
```

## 🔧 常见问题

### Q: 数据库连接失败
**A**: 检查数据库配置和MySQL服务状态
```bash
# 检查MySQL服务
sudo systemctl status mysql

# 测试连接
mysql -h localhost -u root -p
```

### Q: 微信登录失败
**A**: 检查微信小程序配置
1. 确认APPID和SECRET正确
2. 确认小程序域名已配置
3. 查看服务器日志获取详细错误

### Q: JWT Token无效
**A**: 检查JWT密钥配置
1. 确认JWT_SECRET已设置
2. 确认密钥足够复杂
3. 重启服务使配置生效

## 📱 微信小程序配置

### 1. 获取APPID和SECRET
1. 登录微信公众平台: https://mp.weixin.qq.com/
2. 进入开发 -> 开发管理 -> 开发设置
3. 复制AppID和AppSecret

### 2. 配置服务器域名
在微信公众平台设置request合法域名：
```
https://yourdomain.com
```

### 3. 小程序端调用示例
```javascript
// app.js
wx.login({
  success: (res) => {
    wx.request({
      url: 'https://yourdomain.com/api/auth/login',
      method: 'POST',
      data: { code: res.code },
      success: (loginRes) => {
        if (loginRes.data.code === 200) {
          const { accessToken } = loginRes.data.data;
          wx.setStorageSync('token', accessToken);
        }
      }
    });
  }
});
```

## 🛡️ 安全建议

### 1. 生产环境配置
```env
NODE_ENV=production
JWT_SECRET=complex-random-string-at-least-32-chars
JWT_REFRESH_SECRET=another-complex-random-string
```

### 2. 数据库安全
- 使用专用数据库用户，不要使用root
- 设置强密码
- 限制数据库连接来源

### 3. HTTPS配置
生产环境强烈建议使用HTTPS：
```bash
# 使用nginx反向代理
server {
    listen 443 ssl;
    server_name yourdomain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://localhost:3001;
    }
}
```

## 📦 Docker部署（可选）

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
EXPOSE 3001
CMD ["npm", "start"]
```

```bash
# 构建镜像
docker build -t wxnode-api .

# 运行容器
docker run -d -p 3001:3001 --env-file .env wxnode-api
```

## 📞 技术支持

遇到问题请检查：
1. 服务器日志文件 `logs/` 目录
2. 数据库连接状态
3. 环境变量配置
4. 端口是否被占用

---

**提示**: 首次启动可能需要几秒钟进行数据库初始化，请耐心等待。
AIzaSyBWFXEPo6GYJspqhMcBryt5k-M3aOrusxg
AIzaSyAJ2P6LvxI0UZWM7YN49uBsi91RWZThogE