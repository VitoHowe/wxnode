# 🔧 微信小程序后端配置指南

## ❗ 紧急修复：微信登录 "invalid appid" 错误

### 问题描述
如果您遇到以下错误：
```
invalid appid, rid: 68d25902-22912716-170bcc28 (40013)
```

这表示您的项目**缺少微信小程序配置**。

---

## 🚀 快速解决方案

### 步骤 1: 创建环境配置文件

1. **复制配置模板**：
   ```bash
   cp .env.example .env
   ```

2. **或者手动创建 `.env` 文件**，内容如下：
   ```bash
   # 基础服务器配置
   PORT=3000
   NODE_ENV=development
   
   # 数据库配置
   DB_HOST=localhost
   DB_PORT=3306
   DB_NAME=wxnode_db
   DB_USER=root
   DB_PASSWORD=123456
   
   # JWT配置
   JWT_SECRET=your_jwt_secret_here
   JWT_EXPIRES_IN=2h
   JWT_REFRESH_SECRET=your_refresh_secret_here
   JWT_REFRESH_EXPIRES_IN=7d
   
   # 🔑 重要：微信小程序配置（必须填入真实值）
   WECHAT_APPID=你的微信小程序APPID
   WECHAT_SECRET=你的微信小程序SECRET
   ```

### 步骤 2: 获取微信小程序配置

1. **登录微信公众平台**：https://mp.weixin.qq.com/
2. **进入小程序管理后台**
3. **获取配置信息**：
   - 路径：`开发` → `开发管理` → `开发设置`
   - 复制 `AppID(小程序ID)` 和 `AppSecret(小程序密钥)`

   ![微信配置位置示意](https://developers.weixin.qq.com/miniprogram/assets/images/config.png)

### 步骤 3: 更新配置文件

将获取到的真实值填入 `.env` 文件：
```bash
# 🔑 微信小程序配置（替换为您的真实配置）
WECHAT_APPID=wx1234567890abcdef  # 替换为您的真实AppID
WECHAT_SECRET=abcdef1234567890abcdef1234567890  # 替换为您的真实Secret
```

### 步骤 4: 重启服务

```bash
npm run dev
```

---

## 🔍 配置验证

重启服务后，查看控制台日志：

### ✅ 成功的日志：
```
✅ 微信小程序配置检查通过
```

### ❌ 失败的日志：
```
❌ 微信小程序配置缺失
📁 请检查项目根目录是否存在 .env 文件
📋 如果不存在，请复制 .env.example 为 .env 并填入正确配置
🔑 WECHAT_APPID 和 WECHAT_SECRET 需要从微信公众平台获取
🌐 微信公众平台地址: https://mp.weixin.qq.com/
📊 当前配置状态: APPID=未配置, SECRET=未配置
```

---

## 📱 前端调用示例（UniApp）

配置正确后，前端可以这样调用：

```javascript
// UniApp 微信登录
const wechatLogin = async () => {
  try {
    // 1. 获取code
    const loginRes = await uni.login({ provider: 'weixin' });
    
    // 2. 调用后端登录接口
    const response = await uni.request({
      url: 'http://localhost:3000/api/auth/login',
      method: 'POST',
      data: { code: loginRes.code }
    });
    
    console.log('登录成功:', response.data);
    return response.data;
  } catch (error) {
    console.error('登录失败:', error);
    throw error;
  }
};
```

---

## 🔐 安全注意事项

1. **永远不要提交 `.env` 文件到版本控制**
   - `.env` 文件已在 `.gitignore` 中忽略
   - 只提交 `.env.example` 作为模板

2. **生产环境配置**：
   ```bash
   # 生产环境应使用更强的密钥
   JWT_SECRET=use_a_very_long_and_random_string_in_production
   JWT_REFRESH_SECRET=another_very_long_and_random_string_here
   
   # 生产环境应关闭调试功能
   NODE_ENV=production
   ENABLE_SWAGGER=false
   ENABLE_ERROR_DETAILS=false
   ```

3. **微信小程序安全**：
   - 定期更换 AppSecret
   - 不要在前端代码中暴露 Secret
   - 使用HTTPS部署生产环境

---

## 🛠️ 故障排除

### 常见问题1：配置文件不生效
**解决方案**：确保 `.env` 文件在项目根目录，与 `package.json` 同级

### 常见问题2：APPID格式错误
**解决方案**：APPID应以 `wx` 开头，长度通常为18位

### 常见问题3：Secret错误
**解决方案**：Secret是32位的十六进制字符串，请从微信公众平台复制完整内容

### 常见问题4：开发者工具测试失败
**解决方案**：
1. 确保微信开发者工具中的AppID与`.env`中一致
2. 检查小程序是否已发布或设置为开发版本
3. 确认开发者账号已添加到小程序的开发者列表

---

## 📞 技术支持

如果仍然遇到问题，请检查：
1. `.env` 文件是否存在且位置正确
2. 配置值是否有多余的空格或引号
3. 微信公众平台中的小程序状态是否正常
4. 服务器是否可以正常访问微信API

完成配置后，您的微信小程序登录功能将正常工作！🎉
